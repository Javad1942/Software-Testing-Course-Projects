name: Run Python Tests & Check Coverage

on:
  pull_request:
    branches: [ main ]

jobs:
  # === Job for Project 1 ===
  project-1-test:
    if: ${{ startsWith(github.head_ref, 'project-1') }}
    runs-on: ubuntu-latest
    # Define the working directory for all steps in this job
    defaults:
      run:
        working-directory: ./Projects/unit-testing-calculator-01
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install Dependencies
        run: pip install pytest # No need for path here, we are already inside
      - name: Run Pytest for Project 1
        run: pytest -v # No need for path here

  # === Job for Project 2 ===
  project-2-test:
    if: ${{ startsWith(github.head_ref, 'project-2') }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./Projects/api-testing-omdb-02
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install Dependencies
        run: pip install pytest requests
      - name: Run Pytest for Project 2
        run: pytest -v

  # === Job for Project 3 ===
  project-3-test:
    if: ${{ startsWith(github.head_ref, 'project-3') }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./Projects/ui-testing-selenium-03
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install Dependencies
        run: pip install pytest selenium
      - name: Run Pytest for Project 3
        run: pytest -v

  # === Job for Project 4 ===
  project-4-coverage-test:
    if: ${{ startsWith(github.head_ref, 'project-4') }}
    runs-on: ubuntu-latest
    # Note: Working directory is set within the run step for Gunicorn
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install All Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest requests selenium flask pytest-cov gunicorn
      - name: Run Pytest with Coverage Check
        # Run Flask server and tests from the correct directory
        working-directory: ./Projects/e2e-testing-todo-app-04
        run: |
          # Start the server in the background (already in the right dir)
          gunicorn app:app --daemon
          sleep 3 # Wait for server to start
          # Run tests (already in the right dir)
          pytest -v --cov=app --cov-fail-under=85
